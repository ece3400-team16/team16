<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Lab 4</title>
    <link rel="shortcut icon" href="favicon-paper-plane.ico" />
    

    <!-- Bootstrap Core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="vendor/simple-line-icons/css/simple-line-icons.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/stylish-portfolio.min.css" rel="stylesheet">

  </head>

  <body id="page-top">

    <!-- Navigation -->
    <a class="menu-toggle rounded" href="#">
      <i class="fas fa-bars"></i>
    </a>
    <nav id="sidebar-wrapper">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-item">
          <a class="js-scroll-trigger" href="index.html#page-top">Home</a>
        </li>
        <li class="sidebar-nav-item">
          <a class="js-scroll-trigger" href="index.html#about">About</a>
        </li>
        <li class="sidebar-nav-item">
          <a class="js-scroll-trigger" href="index.html#milestones">Milestones</a>
        </li>
        <li class="sidebar-nav-item">
          <a class="js-scroll-trigger" href="index.html#labs">Labs</a>
        </li>
      </ul>
    </nav>

    <!-- Header -->
    <header class="masthead d-flex">
      <div class="container text-center my-auto">
        <h1 class="mb-1">Lab 4</h1>
        <h3 class="mb-5">
          <em>We can see clearly now, the rain is gone (kinda)</em>
        </h3>
        <a class="btn btn-primary btn-xl js-scroll-trigger" href="#about">Wanna know more?</a>
      </div>
      <div class="overlay"></div>
    </header>

    <section id="about" class="content-section">
      <div class="container">
        <h1>Objective</h1>
        <p>For this lab, we used an FPGA (specifically, a DE0-Nano board), an Arduino, and an OV7670 camera, to create a functional camera and a system that distinguishes red and blue color.  The FPGA is used to clock the camera and read from the camera’s byte output, and transform said output into data that can be stored in memory and displayed on a screen.  The Arduino is simply used to write register data to the camera.  The FPGA also transmits data (majority-red/blue color data) to the Arduino.  This entire system will be further expanded and implemented on our robot for the final competition, which involves detecting different colored (red/blue) and different shaped treasures.</p>
        <h1>Procedure</h1>
        <p>The main goal in Lab 4 was to get the camera up and running and have our system distinguish between red and blue color, as well as communicate whether a treasure even exists.  Although our live camera feed is still quite imperfect (this will likely cause problems for shape-detection further down the road), our system does indeed successfully meet this overarching goal of distinguishing color.  The steps we took to complete this task are outlined below:</p>
        <ul>
          <li>Create a Phase-Locked-Loop to ensure that the several clocks we require (the OV7670 requires a 24-MHz clock, the VGA module requires a 25-MHz clock, etc.) are treated in the FPGA as actual clock lines and that they are not skewed</li>
          <li>
            <p>On the Arduino:</p>
            <ul>
              <li>Determine the register values needed to be written to their specific register addresses (using the OV7670 datasheet)</li>
              <li>Write these register values to the camera via the Arduino (and a sketch file)</li>
              <li>Successfully reading color data sent from the FPGA</li>
            </ul>
          </li>
          <li>
            <p>On the FPGA:</p>
            <ul>
              <li>Correctly display memory contents of an FPGA onto a screen</li>
              <li>Correctly parse camera information (in our case, RGB-565-formatted data), and display it to the screen</li>
              <li>Accurately determine if most pixels from the camera feed are red/blue (distinguishing color), and correctly sending such data</li>
            </ul>
          </li>
          <li>
            <p>Integration:</p>
            <ul>
              <li>Wiring the Arduino, Camera, and FPGA all together correctly such that the FPGA can successfully communicate color distinguishment to the Arduino</li>
            </ul>
          </li>
        </ul>
      </div>
    </section>

    <!-- Milestones -->
    <section class="content-section bg-primary text-white text-center" id="milestones">
      <div class="container">
        <div class="content-section-heading">
          <h2 class="mb-5">Let's Break it Down</h2>
        </div>
        <div class="row">
            <div class="col-lg-3 col-md-6 mb-5 mb-lg-0">
              <a href="#pll" class="text-white text-center js-scroll-trigger">
              <span class="service-icon rounded-circle mx-auto mb-3">
                <i class="far fa-lightbulb"></i>
              </span>
              <h4>
                <strong>Phase-Locked Loop (PLL)</strong>
              </h4>
              <p class="text-faded mb-0"></p>
            </a>
            </div>
          <div class="col-lg-3 col-md-6 mb-5 mb-lg-0">
            <a href="#arduino" class="text-white text-center js-scroll-trigger">
              <span class="service-icon rounded-circle mx-auto mb-3">
                <i class="fas fa-screwdriver"></i>
              </span>
              <h4>
                <strong>Arduino Side</strong>
              </h4>
              <p class="text-faded mb-0"></p>
            </a>
          </div>
          <div class="col-lg-3 col-md-6 mb-5 mb-md-0">
            <a href="#fpga" class="text-white text-center js-scroll-trigger">
              <span class="service-icon rounded-circle mx-auto mb-3">
                <i class="fas fa-toolbox"></i>
              </span>
              <h4>
                <strong>FPGA Side</strong>
              </h4>
              <p class="text-faded mb-0"></p>
            </a>
          </div>
          <div class="col-lg-3 col-md-6">
            <a href="#problems" class="text-white text-center js-scroll-trigger">
              <span class="service-icon rounded-circle mx-auto mb-3">
                <i class="fas fa-car-crash"></i>
              </span>
              <h4>
                <strong>Roadblocks and Obstacles</strong>
              </h4>
              <p class="text-faded mb-0"></p>
            </a>
          </div>
        </div>
      </div>
    </section>

    <section class="content-section" id="pll">
      <div class="container">
        <h1>Phase Locked Loop (PLL)</h1>
        <p>There are multiple clocks of different frequencies needed in our system; in order to lock them all together we initialized a phased- locked- loop (this ensures that there is minimal clock skew in our system).  We created another file with an overall clock at 50 MHz.  We then initialized each of our output clocks at 24, 25, and 50 MHz with 50% duty cycles.  We then assigned an output pin for the 24 MHz clock (to be wired to the camera).</p>
      </div>
    </section>

    <section id="analyzing_potentiometers" class="content-section bg-primary text-white">
      <div class="container">
        <h1>Arduino Side</h1>
        <h3>Registers</h3>
        <p>The registers we write to are described in the following table:</p>
        <table style="width:100%">
          <tr>
            <th>Register</th>
            <th>Address</th> 
            <th>Value</th>
            <th>Purpose</th>
          </tr>
          <tr>
            <td>COM7</td>
            <td>0x12</td> 
            <td>0x80</td>
            <td>Resets all registers to default values</td>
          </tr>
          <tr>
            <td>COM3</td>
            <td>0x0C</td> 
            <td>0x08</td>
            <td>Enables scaling</td>
          </tr>
          <tr>
            <td>CLKRC</td>
            <td>0x11</td>
            <td>0xC0</td>
            <td>Enables ‘double-clocking’ and tells camera to use external clock</td>
          </tr>
          <tr>
            <td>COM15</td>
            <td>0x40</td>
            <td>0xD0</td>
            <td>Set output resolution to RGB-565</td>
          </tr>
          <tr>
            <td>COM7</td>
            <td>0x12</td>
            <td>0x0E, 0x0C</td>
            <td>QCIF format, and Color bar test enable, QCIF format, and Color bar test disable</td>
          </tr>
          <tr>
            <td>COM17</td>
            <td>0x42</td>
            <td>0x08, 0x00</td>
            <td>Enable color bar test, Disable color bar test</td>
          </tr>
          <tr>
            <td>MVFP</td>
            <td>0x1E</td>
            <td>0x30</td>
            <td>Flip and mirror the image</td>
          </tr>
        </table>
        <p>Again, these values were determined by looking through the OV7670 data sheet.</p>
        <h3>Writing Register Values from Arduino</h3>
        <p>The wiring for the camera-Arduino is shown in the following picture:</p>
        <div class="container">
          <div class="row no-gutters">
            <div class="col-lg-6">
              <a class="portfolio-item">
                <img class="img-fluid" src="img/lab4/arduino_diagram.png" alt="">
              </a>
            </div>
          </div>
        </div>
        <p>On the camera, the pins SIOC and SIOD correspond to SCL and SDA respectively.</p>
        <p>And here’s a picture of our Arduino/Camera system:</p>
        <h3>Receiving FPGA data</h3>
        <p>We initialized 2 output pins in our Verilog code that would carry either 00 (neither), 01 (blue), or 10 (red).  We then analyzed the output of the image processor (the RESULT variable) by linking each bit with an LED on the FPGA and examining which LEDs were lit.  We used the LEDs to test whether our image processor worked, before hooking these pins from the FPGA up to the Arduino.  The two pins were then directly connected into digital input pins on the Arduino with their variables initialized in the code.  In order to show the code worked, we held a color test image up to the camera and then had the code print out whether it was red or blue.</p>
      </div>
    </section>

    <section id="fpga" class="content-section">
      <div class="container">
        <h1>FPGA Side</h1>
        <h3>Displaying M9K memory contents</h3>
        <p>One of our initial tasks was to write a pattern directly into the FPGA memory and display it on the screen.  We created an always block that updated on the positive edge of the 25MHz clock, that would enable memory writing if the X and Y addresses were inside the picture frame. We then wrote in colors directly into the pixel_data_RGB332 variable which would then be stored in the current address in memory, depending on whether they were in the range for the shape we wanted to create.  The X and Y write addresses were subsequently changed as long as they were still within the screen width and height.</p>
        <p>We successfully outputted our test pattern (a simple/arbitrary cross) as you can see below:</p>
        <img>
        <h3>Down-sampler: color bar and camera feed</h3>
        <p>The downsampler takes the RGB 565 format image from the camera and then turns it into 8 bits that can be stored in our memory.  RGB 565 format for pixels means one pixel equates to two bytes of information (first 5 pixels red, next 3 green, then next 3 green last 5 blue).  We essentially parse the 565 data into 332 data by selecting the most significant digits for each color and enter them into the 8 bit 332 format.</p>
        <p>When the camera V_Sync signal is high, this signals the end of an entire frame, so we reset the X and Y addresses.  When V_Sync is low, and HREF was high, pixel data is transmitted row by row.  Since the RGB 565 pixel data comes in bytes, and each pixel is two bytes of 565 data, we have to read across two clock cycles (of PCLK, outputted from the camera) to get the full info of one pixel.  We use an auxiliary variable to keep track of which pixel (first or second) we are receiving, and store the camera input data in a register.  When HREF is low again, the row is over and the Y address updates (we move down a row).</p>
        <p>Here is our down-sampler code:</p>
        <p>In order to test that the correct colors were being constructed after the downsampling, we updated the registers in the Arduino code to show a color bar and then checked to see that the correct colors were shown.  Below is a picture of the color bar test:</p>
        <img>
        <p>We had trouble getting a consistent camera feed.  While we managed to get reasonable colors and defined shapes, our video seemed to update in bars, which was best described as “flickering”. Despite looking through our code many times, analyzing the clocks, replacing all the hardware, and rewiring at least once, we were unable to get a clean image unless the gain was turned very low, at which point the feed was very dark.</p>
        <h3>Color Distinguishment</h3>
        <p>We wrote the image processor module to identify what was the dominant color of the frame it was seeing.  We created registers which update each time the RGB pixels from the downsampler with the color that is the largest in those bits (if the 2 of the 3 red read 1, the red updates, and if the 2 blue are high, the blue register updates).  At the end of a frame, the totals are compared and the output RESULT is assigned to either 9’b01 if blue or 9’b10 if red, before all the variables are reset.</p>
        <p>To test the image processor we assigned LEDs on the FPGA to light up depending on the output and then saw if the right ones lit up according to the test color.</p>
      </div>
    </section>

    <section id="problems" class="content-section bg-primary text-white">
      <div class="container">
        
      </div>
    </section>

    <!-- Map -->
    <!-- POINT TO PHILLIPS -->
    <section id="contact" class="map">
      <iframe width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com/maps?q=phillips%20hall%2C%20ithaca&t=&z=13&ie=UTF8&iwloc=&output=embed"></iframe>
      <br/>
      <small>
        <a href="https://www.google.com/maps/place/Phillips+Hall/@42.4445807,-76.4842416,17z/data=!4m7!3m6!1s0x89d0818c816cffe3:0xfd9ee07ff22c5aa4!8m2!3d42.4445768!4d-76.4820529!9m1!1b1"></a>
      </small>
    </section>

    <!-- Footer -->
    <footer class="footer text-center">
      <div class="container">
        <ul class="list-inline mb-5">
          <li class="list-inline-item">
            <a class="social-link rounded-circle text-white" href="https://github.com/ece3400-team16">
              <i class="icon-social-github"></i>
            </a>
          </li>
        </ul>
        <p class="text-muted small mb-0">Copyright &copy; ECE 3400 2018</p>
      </div>
    </footer>

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded js-scroll-trigger" href="#page-top">
      <i class="fas fa-angle-up"></i>
    </a>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for this template -->
    <script src="js/stylish-portfolio.min.js"></script>

  </body>

</html>
